name: Run the WebGL build

on:
  pull_request: {}

jobs:
  build:
    name: Run the WebGL build
    runs-on: ubuntu-latest
    steps:
      # actions/checkout@v2 ã‚’åˆ©ç”¨ã—ã¦ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«
      # Unity ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä¸­èº«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã‚‹
      - name: Check out my unity project.
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      # GameCI ã® Builder ã‚’åˆ©ç”¨ã—ã¦ã€
      # Unity ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ“ãƒ«ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹
      - name: Run the WebGL build
        uses: game-ci/unity-builder@v2
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
        with:
          # ä»Šå›ã¯ WebGL ãƒ“ãƒ«ãƒ‰ã‚’è¡Œã„ãŸã„ãŸã‚ WebGL ã‚’æŒ‡å®šã™ã‚‹
          # WebGL ä»¥å¤–ã®æŒ‡å®šå¯èƒ½ãªå€¤ã¯ä¸‹è¨˜ã«è¨˜è¼‰ã®å€¤ãŒåˆ©ç”¨å¯èƒ½
          # ref: https://docs.unity3d.com/ScriptReference/BuildTarget.html
          targetPlatform: WebGL

          unityVersion: 2021.3.14f1
      # Builder ã§å‡ºåŠ›ã—ãŸ WebGL ãƒ“ãƒ«ãƒ‰ã‚’ GitHub Pages ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹
      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@4.1.3
        with:
          # GitHub Pages ãƒ‡ãƒ—ãƒ­ã‚¤ç”¨ã® Orphan ãƒ–ãƒ©ãƒ³ãƒåã‚’æŒ‡å®šã™ã‚‹
          branch: gh-page1

          # ãƒ‡ãƒ—ãƒ­ã‚¤ç”¨ãƒ“ãƒ«ãƒ‰ãƒ•ã‚©ãƒ«ãƒ€ãƒ‘ã‚¹ã‚’æŒ‡å®šã™ã‚‹
          # GameCI ã® Builder ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ build ãƒ•ã‚©ãƒ«ãƒ€ã«ãƒ“ãƒ«ãƒ‰å†…å®¹ã‚’å‡ºåŠ›ã™ã‚‹
          folder: build
      - name: Send GitHub Action trigger data to Slack workflow
        id: slack
        uses: slackapi/slack-github-action@v1.16.0
        with:
          payload: |
            {
              "text": "ğŸ”§ ãƒ“ãƒ«ãƒ‰çµæœ: ${{ job.status }}\n\n${{ github.event.pull_request.html_url || github.event.head_commit.url }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "ğŸ”§ ãƒ“ãƒ«ãƒ‰çµæœ: ${{ job.status }}\n\n${{ github.event.pull_request.html_url || github.event.head_commit.url }}"
                  }
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": "Author: <https://github.com/${{ github.event.sender.login }}|@${{ github.event.sender.login }}>"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_INCOMING_WEBHOOK_URL }}


      # Builder ã§å‡ºåŠ›ã—ãŸ WebGL ãƒ“ãƒ«ãƒ‰ã‚’ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¯èƒ½ã«ã™ã‚‹
      - name: Upload the WebGL Build
        uses: actions/upload-artifact@v2
        with:
          name: Build
          path: build
